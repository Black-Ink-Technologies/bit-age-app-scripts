"use strict";var IdentityVerificationCDN=(()=>{var ze=Object.defineProperty;var de=Object.getOwnPropertySymbols;var Ge=Object.prototype.hasOwnProperty,Fe=Object.prototype.propertyIsEnumerable;var fe=(i,e,t)=>e in i?ze(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,j=(i,e)=>{for(var t in e||(e={}))Ge.call(e,t)&&fe(i,t,e[t]);if(de)for(var t of de(e))Fe.call(e,t)&&fe(i,t,e[t]);return i};var b=(i,e,t)=>new Promise((n,s)=>{var r=c=>{try{a(t.next(c))}catch(u){s(u)}},o=c=>{try{a(t.throw(c))}catch(u){s(u)}},a=c=>c.done?n(c.value):Promise.resolve(c.value).then(r,o);a((t=t.apply(i,e)).next())});var I="https://develop-api.chainit.online",_e="/rule-engine/v1/age-app-embed/generate-qr",pe="/rule-engine/v1/age-app-embed/get-qr",ge="/rule-engine/v1/age-app-embed/destroy",me="/public-api/v1/embed/validate",be="/users/v1/centrifugal/token/ageapp-embed-screen",ve="wss://ws-dev.chainit.online/connection/websocket",Y="x-sign-key",ye="x-organization-id",X={"Content-Type":"application/json"},Se={AGE_APP:"age_app",CHECK_IN:"check_in"},Z="#embed-qr-code",A="#embed-qr-code-logs",Te=1500,q=1e4,_={WaitingForScan:"WaitingForScan",Timeout:"Timeout",Scanned:"Scanned",Approved:"Approved",RejectedByUser:"RejectedByUser",RejectedByRequirement:"RejectedByRequirement",SomethingWentWrong:"SomethingWentWrong"};var we=i=>({Timeout:`
    <div style="margin-bottom: 10px; color: #fff;">QR Expired.</div>
    <a id='new-qr-button' style="
      margin-top: 10px;
      display: inline-block;
      padding: 10px 20px;
      background-color: #000;
      border: 1px solid #fff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      cursor:pointer;
    ">New QR</a>
  `,Scanned:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u23F3</div>
    <div style="color: #fff;">Scanning In Progress...</div>
    <a id='new-qr-button' style="
      margin-top: 10px;
      display: inline-block;
      padding: 10px 20px;
      background-color: #000;
      border: 1px solid #fff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      cursor:pointer;
    ">Generate New QR</a>
  `,Approved:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u2705</div>
    <div style="color: #00ff99;">Condition: Age is greater than or equal to 18 \u2192 Pass</div>
  `,RejectedByUser:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Condition: Age is greater than or equal to 18 \u2192 Fail</div>
  `,RejectedByRequirement:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Condition: Age is greater than or equal to 18 \u2192 Fail</div>
  `,WaitingForScan:"",SomethingWentWrong:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u26A0\uFE0F</div>
    <div style="color: #ff4444;">Something Went Wrong</div>
  `})[i],Ee=i=>({Timeout:"QR Expired",Scanned:"Scanning in progress",Approved:"Condition: Age is greater than or equal to 18 \u2192 Pass",RejectedByUser:"Condition: Age is greater than or equal to 18 \u2192 Fail",RejectedByRequirement:"Condition: Age is greater than or equal to 18 \u2192 Fail",WaitingForScan:"Waiting for scan",SomethingWentWrong:"Something went wrong"})[i],ee=(i="Something went wrong")=>`<div style="background:#111;color:#fff;padding:10px 14px;border-radius:6px;font-size:14px;">${i}</div>`;function Re(i){return`
    <div id="qr-code" class="w-100 h-100" style="cursor:pointer;text-align:center;">
      <img src="${i}" alt="QR Code" style="width:100%;height:100%;" />
    </div>
    `}var E=i=>document.querySelector(i);function x(i,e,t){if(!i)return;let n=document.createElement("p");n.innerHTML=t||Ee(e),n.style.cssText="margin-bottom:10px;padding:8px;",i.prepend(n)}var W=(i,e)=>setTimeout(()=>window.location.href=i,e);var k=(...i)=>console.log("[cdn-embed]",...i),y=(...i)=>console.error("[cdn-embed]",...i),D=(...i)=>console.warn("[cdn-embed]",...i);var Pe=()=>{let i=document.currentScript;return{apiKey:(i==null?void 0:i.dataset.apiKey)||"",successRedirectURL:(i==null?void 0:i.dataset.successUrl)||"",failRedirectURL:(i==null?void 0:i.dataset.failureUrl)||"",notificationURL:(i==null?void 0:i.dataset.notificationUrl)||""}},Ce=()=>b(null,null,function*(){try{return(yield Be())==="denied"?(D("Geolocation permission denied by user."),yield z()):"geolocation"in navigator?yield new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{var r,o,a,c;let n=(o=(r=t==null?void 0:t.coords)==null?void 0:r.latitude)!=null?o:0,s=(c=(a=t==null?void 0:t.coords)==null?void 0:a.longitude)!=null?c:0;e({latitude:n,longitude:s})},t=>b(null,null,function*(){let n="";switch(t.code){case t.PERMISSION_DENIED:n="User denied location access.";break;case t.POSITION_UNAVAILABLE:n="Location position unavailable.";break;case t.TIMEOUT:n="Location request timed out.";break;default:n="Unknown geolocation error."}y(`ERR_LOC: ${n}`,t);let s=yield z();e(s)}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}):(D("Geolocation API not supported by this browser."),yield z())}catch(i){return y("Unexpected geolocation error:",i),yield z()}}),z=()=>b(null,null,function*(){try{let e=yield(yield fetch("https://ipapi.co/json/")).json();if(e&&e.latitude&&e.longitude)return D("Fallback via IP-based location:",e.latitude,e.longitude),{latitude:e.latitude,longitude:e.longitude}}catch(i){D("IP-based geolocation failed:",i)}return D("Returning final fallback location (0,0)."),{latitude:0,longitude:0}}),Be=()=>b(null,null,function*(){if(!("permissions"in navigator))return"prompt";try{return(yield navigator.permissions.query({name:"geolocation"})).state}catch(i){return"prompt"}});function te(t){return b(this,arguments,function*(i,e={}){let n=yield fetch(i,{method:"GET",headers:e});if(!n.ok){let s=yield n.json(),r=ie(s);throw x(E(A||""),"SomethingWentWrong"),new Error(`${n.status} : ${r}`)}return n.json()})}function xe(t){return b(this,arguments,function*(i,e={}){let n=yield fetch(i,{method:"DELETE",headers:j(j({},X),e)});if(!n.ok){let s=yield n.json(),r=ie(s);throw x(E(A||""),"SomethingWentWrong"),new Error(`${n.status} : ${r}`)}return n})}function ne(n,s){return b(this,arguments,function*(i,e,t={}){let r=yield fetch(i,{method:"POST",headers:j(j({},X),t),body:JSON.stringify(e)});if(!r.ok){let o=yield r.json(),a=ie(o);throw x(E(A||""),"SomethingWentWrong"),new Error(`${r.status} : ${a}`)}return r.json()})}function ie(i){var t;let e="Something Went Wrong";return i!=null&&i.errors&&((t=i==null?void 0:i.errors)!=null&&t.length)?e=i.errors[0].message:i.message&&(e=i.message),e}function T(i,e,t,n){function s(r){return r instanceof t?r:new t(function(o){o(r)})}return new(t||(t=Promise))(function(r,o){function a(g){try{u(n.next(g))}catch(C){o(C)}}function c(g){try{u(n.throw(g))}catch(C){o(C)}}function u(g){g.done?r(g.value):s(g.value).then(a,c)}u((n=n.apply(i,e||[])).next())})}function Ve(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var le={exports:{}},U=typeof Reflect=="object"?Reflect:null,ke=U&&typeof U.apply=="function"?U.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},G;U&&typeof U.ownKeys=="function"?G=U.ownKeys:Object.getOwnPropertySymbols?G=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:G=function(e){return Object.getOwnPropertyNames(e)};function He(i){console&&console.warn&&console.warn(i)}var Oe=Number.isNaN||function(e){return e!==e};function h(){h.init.call(this)}le.exports=h;le.exports.once=Ke;h.EventEmitter=h;h.prototype._events=void 0;h.prototype._eventsCount=0;h.prototype._maxListeners=void 0;var Le=10;function J(i){if(typeof i!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof i)}Object.defineProperty(h,"defaultMaxListeners",{enumerable:!0,get:function(){return Le},set:function(i){if(typeof i!="number"||i<0||Oe(i))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+i+".");Le=i}});h.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};h.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Oe(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Ie(i){return i._maxListeners===void 0?h.defaultMaxListeners:i._maxListeners}h.prototype.getMaxListeners=function(){return Ie(this)};h.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s=e==="error",r=this._events;if(r!==void 0)s=s&&r.error===void 0;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=r[e];if(c===void 0)return!1;if(typeof c=="function")ke(c,this,t);else for(var u=c.length,g=je(c,u),n=0;n<u;++n)ke(g[n],this,t);return!0};function Ae(i,e,t,n){var s,r,o;if(J(t),r=i._events,r===void 0?(r=i._events=Object.create(null),i._eventsCount=0):(r.newListener!==void 0&&(i.emit("newListener",e,t.listener?t.listener:t),r=i._events),o=r[e]),o===void 0)o=r[e]=t,++i._eventsCount;else if(typeof o=="function"?o=r[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),s=Ie(i),s>0&&o.length>s&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=i,a.type=e,a.count=o.length,He(a)}return i}h.prototype.addListener=function(e,t){return Ae(this,e,t,!1)};h.prototype.on=h.prototype.addListener;h.prototype.prependListener=function(e,t){return Ae(this,e,t,!0)};function Qe(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function De(i,e,t){var n={fired:!1,wrapFn:void 0,target:i,type:e,listener:t},s=Qe.bind(n);return s.listener=t,n.wrapFn=s,s}h.prototype.once=function(e,t){return J(t),this.on(e,De(this,e,t)),this};h.prototype.prependOnceListener=function(e,t){return J(t),this.prependListener(e,De(this,e,t)),this};h.prototype.removeListener=function(e,t){var n,s,r,o,a;if(J(t),s=this._events,s===void 0)return this;if(n=s[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(r=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,r=o;break}if(r<0)return this;r===0?n.shift():$e(n,r),n.length===1&&(s[e]=n[0]),s.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};h.prototype.off=h.prototype.removeListener;h.prototype.removeAllListeners=function(e){var t,n,s;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var r=Object.keys(n),o;for(s=0;s<r.length;++s)o=r[s],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function Ue(i,e,t){var n=i._events;if(n===void 0)return[];var s=n[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?Je(s):je(s,s.length)}h.prototype.listeners=function(e){return Ue(this,e,!0)};h.prototype.rawListeners=function(e){return Ue(this,e,!1)};h.listenerCount=function(i,e){return typeof i.listenerCount=="function"?i.listenerCount(e):Ne.call(i,e)};h.prototype.listenerCount=Ne;function Ne(i){var e=this._events;if(e!==void 0){var t=e[i];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}h.prototype.eventNames=function(){return this._eventsCount>0?G(this._events):[]};function je(i,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=i[n];return t}function $e(i,e){for(;e+1<i.length;e++)i[e]=i[e+1];i.pop()}function Je(i){for(var e=new Array(i.length),t=0;t<e.length;++t)e[t]=i[t].listener||i[t];return e}function Ke(i,e){return new Promise(function(t,n){function s(o){i.removeListener(e,r),n(o)}function r(){typeof i.removeListener=="function"&&i.removeListener("error",s),t([].slice.call(arguments))}Me(i,e,r,{once:!0}),e!=="error"&&Ye(i,s,{once:!0})})}function Ye(i,e,t){typeof i.on=="function"&&Me(i,"error",e,t)}function Me(i,e,t,n){if(typeof i.on=="function")n.once?i.once(e,t):i.on(e,t);else if(typeof i.addEventListener=="function")i.addEventListener(e,function s(r){n.once&&i.removeEventListener(e,s),t(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof i)}var Xe=le.exports,qe=Ve(Xe),d;(function(i){i[i.timeout=1]="timeout",i[i.transportClosed=2]="transportClosed",i[i.clientDisconnected=3]="clientDisconnected",i[i.clientClosed=4]="clientClosed",i[i.clientConnectToken=5]="clientConnectToken",i[i.clientRefreshToken=6]="clientRefreshToken",i[i.subscriptionUnsubscribed=7]="subscriptionUnsubscribed",i[i.subscriptionSubscribeToken=8]="subscriptionSubscribeToken",i[i.subscriptionRefreshToken=9]="subscriptionRefreshToken",i[i.transportWriteError=10]="transportWriteError",i[i.connectionClosed=11]="connectionClosed",i[i.badConfiguration=12]="badConfiguration"})(d||(d={}));var L;(function(i){i[i.connectCalled=0]="connectCalled",i[i.transportClosed=1]="transportClosed",i[i.noPing=2]="noPing",i[i.subscribeTimeout=3]="subscribeTimeout",i[i.unsubscribeError=4]="unsubscribeError"})(L||(L={}));var M;(function(i){i[i.disconnectCalled=0]="disconnectCalled",i[i.unauthorized=1]="unauthorized",i[i.badProtocol=2]="badProtocol",i[i.messageSizeLimit=3]="messageSizeLimit"})(M||(M={}));var F;(function(i){i[i.subscribeCalled=0]="subscribeCalled",i[i.transportClosed=1]="transportClosed"})(F||(F={}));var B;(function(i){i[i.unsubscribeCalled=0]="unsubscribeCalled",i[i.unauthorized=1]="unauthorized",i[i.clientClosed=2]="clientClosed"})(B||(B={}));var p;(function(i){i.Disconnected="disconnected",i.Connecting="connecting",i.Connected="connected"})(p||(p={}));var S;(function(i){i.Unsubscribed="unsubscribed",i.Subscribing="subscribing",i.Subscribed="subscribed"})(S||(S={}));function Ze(i,e){return i.lastIndexOf(e,0)===0}function We(i){return i==null?!1:typeof i=="function"}function et(i,e){if(globalThis.console){let t=globalThis.console[i];We(t)&&t.apply(globalThis.console,e)}}function tt(i,e){return Math.floor(Math.random()*(e-i+1)+i)}function V(i,e,t){i>31&&(i=31);let n=tt(0,Math.min(t,e*Math.pow(2,i)));return Math.min(t,e+n)}function nt(i){return"error"in i&&i.error!==null}function H(i){return Math.min(i*1e3,2147483647)}var se=class extends qe{constructor(e,t,n){super(),this._resubscribeTimeout=null,this._refreshTimeout=null,this.channel=t,this.state=S.Unsubscribed,this._centrifuge=e,this._token="",this._getToken=null,this._data=null,this._getData=null,this._recover=!1,this._offset=null,this._epoch=null,this._recoverable=!1,this._positioned=!1,this._joinLeave=!1,this._minResubscribeDelay=500,this._maxResubscribeDelay=2e4,this._resubscribeTimeout=null,this._resubscribeAttempts=0,this._promises={},this._promiseId=0,this._inflight=!1,this._refreshTimeout=null,this._delta="",this._delta_negotiated=!1,this._prevValue=null,this._unsubPromise=Promise.resolve(),this._setOptions(n),this._centrifuge._debugEnabled?(this.on("state",s=>{this._debug("subscription state",t,s.oldState,"->",s.newState)}),this.on("error",s=>{this._debug("subscription error",t,s)})):this.on("error",function(){Function.prototype()})}ready(e){return this.state===S.Unsubscribed?Promise.reject({code:d.subscriptionUnsubscribed,message:this.state}):this.state===S.Subscribed?Promise.resolve():new Promise((t,n)=>{let s={resolve:t,reject:n};e&&(s.timeout=setTimeout(function(){n({code:d.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=s})}subscribe(){this._isSubscribed()||(this._resubscribeAttempts=0,this._setSubscribing(F.subscribeCalled,"subscribe called"))}unsubscribe(){this._unsubPromise=this._setUnsubscribed(B.unsubscribeCalled,"unsubscribe called",!0)}publish(e){return T(this,void 0,void 0,function*(){return yield this._methodCall(),this._centrifuge.publish(this.channel,e)})}presence(){return T(this,void 0,void 0,function*(){return yield this._methodCall(),this._centrifuge.presence(this.channel)})}presenceStats(){return T(this,void 0,void 0,function*(){return yield this._methodCall(),this._centrifuge.presenceStats(this.channel)})}history(e){return T(this,void 0,void 0,function*(){return yield this._methodCall(),this._centrifuge.history(this.channel,e)})}_methodCall(){return this._isSubscribed()?Promise.resolve():this._isUnsubscribed()?Promise.reject({code:d.subscriptionUnsubscribed,message:this.state}):new Promise((e,t)=>{let n=this._centrifuge._config.timeout,s=setTimeout(()=>{t({code:d.timeout,message:"timeout"})},n);this._promises[this._nextPromiseId()]={timeout:s,resolve:e,reject:t}})}_nextPromiseId(){return++this._promiseId}_needRecover(){return this._recover===!0}_isUnsubscribed(){return this.state===S.Unsubscribed}_isSubscribing(){return this.state===S.Subscribing}_isSubscribed(){return this.state===S.Subscribed}_setState(e){if(this.state!==e){let t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t,channel:this.channel}),!0}return!1}_usesToken(){return this._token!==""||this._getToken!==null}_clearSubscribingState(){this._resubscribeAttempts=0,this._clearResubscribeTimeout()}_clearSubscribedState(){this._clearRefreshTimeout()}_setSubscribed(e){if(!this._isSubscribing())return;this._clearSubscribingState(),e.recoverable&&(this._recover=!0,this._offset=e.offset||0,this._epoch=e.epoch||""),e.delta?this._delta_negotiated=!0:this._delta_negotiated=!1,this._setState(S.Subscribed);let t=this._centrifuge._getSubscribeContext(this.channel,e);this.emit("subscribed",t),this._resolvePromises();let n=e.publications;if(n&&n.length>0)for(let s in n)n.hasOwnProperty(s)&&this._handlePublication(n[s]);e.expires===!0&&(this._refreshTimeout=setTimeout(()=>this._refresh(),H(e.ttl)))}_setSubscribing(e,t){return T(this,void 0,void 0,function*(){this._isSubscribing()||(this._isSubscribed()&&this._clearSubscribedState(),this._setState(S.Subscribing)&&this.emit("subscribing",{channel:this.channel,code:e,reason:t}),this._centrifuge._transport&&this._centrifuge._transport.emulation()&&(yield this._unsubPromise),this._isSubscribing()&&this._subscribe())})}_subscribe(){return this._debug("subscribing on",this.channel),this._isTransportOpen()?this._inflight?null:(this._inflight=!0,this._canSubscribeWithoutGettingToken()?this._subscribeWithoutToken():(this._getSubscriptionToken().then(e=>this._handleTokenResponse(e)).catch(e=>this._handleTokenError(e)),null)):(this._debug("delay subscribe on",this.channel,"till connected"),null)}_isTransportOpen(){return this._centrifuge._transportIsOpen}_canSubscribeWithoutGettingToken(){return!this._usesToken()||!!this._token}_subscribeWithoutToken(){return this._getData?(this._getDataAndSubscribe(this._token),null):this._sendSubscribe(this._token)}_getDataAndSubscribe(e){if(!this._getData){this._inflight=!1;return}this._getData({channel:this.channel}).then(t=>{if(!this._isSubscribing()){this._inflight=!1;return}this._data=t,this._sendSubscribe(e)}).catch(t=>this._handleGetDataError(t))}_handleGetDataError(e){if(!this._isSubscribing()){this._inflight=!1;return}if(e instanceof R){this._inflight=!1,this._failUnauthorized();return}this.emit("error",{type:"subscribeData",channel:this.channel,error:{code:d.badConfiguration,message:(e==null?void 0:e.toString())||""}}),this._inflight=!1,this._scheduleResubscribe()}_handleTokenResponse(e){if(!this._isSubscribing()){this._inflight=!1;return}if(!e){this._inflight=!1,this._failUnauthorized();return}this._token=e,this._getData?this._getDataAndSubscribe(e):this._sendSubscribe(e)}_handleTokenError(e){if(!this._isSubscribing()){this._inflight=!1;return}if(e instanceof R){this._inflight=!1,this._failUnauthorized();return}this.emit("error",{type:"subscribeToken",channel:this.channel,error:{code:d.subscriptionSubscribeToken,message:(e==null?void 0:e.toString())||""}}),this._inflight=!1,this._scheduleResubscribe()}_sendSubscribe(e){if(!this._isTransportOpen())return this._inflight=!1,null;let t=this._buildSubscribeCommand(e);return this._centrifuge._call(t).then(n=>{this._inflight=!1;let s=n.reply.subscribe;this._handleSubscribeResponse(s),n.next&&n.next()},n=>{this._inflight=!1,this._handleSubscribeError(n.error),n.next&&n.next()}),t}_buildSubscribeCommand(e){let t={channel:this.channel};if(e&&(t.token=e),this._data&&(t.data=this._data),this._positioned&&(t.positioned=!0),this._recoverable&&(t.recoverable=!0),this._joinLeave&&(t.join_leave=!0),this._needRecover()){t.recover=!0;let n=this._getOffset();n&&(t.offset=n);let s=this._getEpoch();s&&(t.epoch=s)}return this._delta&&(t.delta=this._delta),{subscribe:t}}_debug(...e){this._centrifuge._debug(...e)}_handleSubscribeError(e){if(this._isSubscribing()){if(e.code===d.timeout){this._centrifuge._disconnect(L.subscribeTimeout,"subscribe timeout",!0);return}this._subscribeError(e)}}_handleSubscribeResponse(e){this._isSubscribing()&&this._setSubscribed(e)}_setUnsubscribed(e,t,n){if(this._isUnsubscribed())return Promise.resolve();let s=Promise.resolve();return this._isSubscribed()?(n&&(s=this._centrifuge._unsubscribe(this)),this._clearSubscribedState()):this._isSubscribing()&&(this._inflight&&n&&(s=this._centrifuge._unsubscribe(this)),this._clearSubscribingState()),this._inflight=!1,this._setState(S.Unsubscribed)&&this.emit("unsubscribed",{channel:this.channel,code:e,reason:t}),this._rejectPromises({code:d.subscriptionUnsubscribed,message:this.state}),s}_handlePublication(e){if(this._delta&&this._delta_negotiated){let{newData:n,newPrevValue:s}=this._centrifuge._codec.applyDeltaIfNeeded(e,this._prevValue);e.data=n,this._prevValue=s}let t=this._centrifuge._getPublicationContext(this.channel,e);this.emit("publication",t),e.offset&&(this._offset=e.offset)}_handleJoin(e){let t=this._centrifuge._getJoinLeaveContext(e.info);this.emit("join",{channel:this.channel,info:t})}_handleLeave(e){let t=this._centrifuge._getJoinLeaveContext(e.info);this.emit("leave",{channel:this.channel,info:t})}_resolvePromises(){for(let e in this._promises)this._promises.hasOwnProperty(e)&&(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(let t in this._promises)this._promises.hasOwnProperty(t)&&(this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t])}_scheduleResubscribe(){if(!this._isSubscribing()){this._debug("not in subscribing state, skip resubscribe scheduling",this.channel);return}let e=this,t=this._getResubscribeDelay();this._resubscribeTimeout=setTimeout(function(){e._isSubscribing()&&e._subscribe()},t),this._debug("resubscribe scheduled after "+t,this.channel)}_subscribeError(e){if(this._isSubscribing())if(e.code<100||e.code===109||e.temporary===!0){e.code===109&&(this._token="");let t={channel:this.channel,type:"subscribe",error:e};this._centrifuge.state===p.Connected&&this.emit("error",t),this._scheduleResubscribe()}else this._setUnsubscribed(e.code,e.message,!1)}_getResubscribeDelay(){let e=V(this._resubscribeAttempts,this._minResubscribeDelay,this._maxResubscribeDelay);return this._resubscribeAttempts++,e}_setOptions(e){if(e&&(e.since&&(this._offset=e.since.offset||0,this._epoch=e.since.epoch||"",this._recover=!0),e.data&&(this._data=e.data),e.getData&&(this._getData=e.getData),e.minResubscribeDelay!==void 0&&(this._minResubscribeDelay=e.minResubscribeDelay),e.maxResubscribeDelay!==void 0&&(this._maxResubscribeDelay=e.maxResubscribeDelay),e.token&&(this._token=e.token),e.getToken&&(this._getToken=e.getToken),e.positioned===!0&&(this._positioned=!0),e.recoverable===!0&&(this._recoverable=!0),e.joinLeave===!0&&(this._joinLeave=!0),e.delta)){if(e.delta!=="fossil")throw new Error("unsupported delta format");this._delta=e.delta}}_getOffset(){let e=this._offset;return e!==null?e:0}_getEpoch(){let e=this._epoch;return e!==null?e:""}_clearRefreshTimeout(){this._refreshTimeout!==null&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearResubscribeTimeout(){this._resubscribeTimeout!==null&&(clearTimeout(this._resubscribeTimeout),this._resubscribeTimeout=null)}_getSubscriptionToken(){this._debug("get subscription token for channel",this.channel);let e={channel:this.channel},t=this._getToken;return t===null?(this.emit("error",{type:"configuration",channel:this.channel,error:{code:d.badConfiguration,message:"provide a function to get channel subscription token"}}),Promise.reject(new R(""))):t(e)}_refresh(){this._clearRefreshTimeout();let e=this;this._getSubscriptionToken().then(function(t){if(!e._isSubscribed())return;if(!t){e._failUnauthorized();return}e._token=t;let s={sub_refresh:{channel:e.channel,token:t}};e._centrifuge._call(s).then(r=>{let o=r.reply.sub_refresh;e._refreshResponse(o),r.next&&r.next()},r=>{e._refreshError(r.error),r.next&&r.next()})}).catch(function(t){if(t instanceof R){e._failUnauthorized();return}e.emit("error",{type:"refreshToken",channel:e.channel,error:{code:d.subscriptionRefreshToken,message:t!==void 0?t.toString():""}}),e._refreshTimeout=setTimeout(()=>e._refresh(),e._getRefreshRetryDelay())})}_refreshResponse(e){this._isSubscribed()&&(this._debug("subscription token refreshed, channel",this.channel),this._clearRefreshTimeout(),e.expires===!0&&(this._refreshTimeout=setTimeout(()=>this._refresh(),H(e.ttl))))}_refreshError(e){this._isSubscribed()&&(e.code<100||e.temporary===!0?(this.emit("error",{type:"refresh",channel:this.channel,error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._setUnsubscribed(e.code,e.message,!0))}_getRefreshRetryDelay(){return V(0,1e4,2e4)}_failUnauthorized(){this._setUnsubscribed(B.unauthorized,"unauthorized",!0)}},re=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"sockjs"}subName(){return"sockjs-"+this._transport.transport}emulation(){return!1}supported(){return this.options.sockjs!==null}initialize(e,t){this._transport=new this.options.sockjs(this.endpoint,null,this.options.sockjsOptions),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=n=>{t.onError(n)},this._transport.onclose=n=>{t.onClose(n)},this._transport.onmessage=n=>{t.onMessage(n.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}},Q=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"websocket"}subName(){return"websocket"}emulation(){return!1}supported(){return this.options.websocket!==void 0&&this.options.websocket!==null}initialize(e,t){let n="";e==="protobuf"&&(n="centrifuge-protobuf"),n!==""?this._transport=new this.options.websocket(this.endpoint,n):this._transport=new this.options.websocket(this.endpoint),e==="protobuf"&&(this._transport.binaryType="arraybuffer"),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=s=>{t.onError(s)},this._transport.onclose=s=>{t.onClose(s)},this._transport.onmessage=s=>{t.onMessage(s.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}},oe=class{constructor(e,t){this.endpoint=e,this.options=t,this._abortController=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"http_stream"}subName(){return"http_stream"}emulation(){return!0}_handleErrors(e){if(!e.ok)throw new Error(e.status);return e}_fetchEventTarget(e,t,n){let s=new EventTarget,r=e.options.fetch;return r(t,n).then(e._handleErrors).then(o=>{s.dispatchEvent(new Event("open"));let a="",c=0,u=new Uint8Array,g=o.body.getReader();return new e.options.readableStream({start(C){function P(){return g.read().then(({done:l,value:w})=>{if(l){s.dispatchEvent(new Event("close")),C.close();return}try{if(e._protocol==="json")for(a+=e._utf8decoder.decode(w);c<a.length;)if(a[c]===`
`){let m=a.substring(0,c);s.dispatchEvent(new MessageEvent("message",{data:m})),a=a.substring(c+1),c=0}else++c;else{let m=new Uint8Array(u.length+w.length);for(m.set(u),m.set(w,u.length),u=m;;){let f=e.options.decoder.decodeReply(u);if(f.ok){let N=u.slice(0,f.pos);s.dispatchEvent(new MessageEvent("message",{data:N})),u=u.slice(f.pos);continue}break}}}catch(m){s.dispatchEvent(new Event("error",{detail:m})),s.dispatchEvent(new Event("close")),C.close();return}P()}).catch(function(l){s.dispatchEvent(new Event("error",{detail:l})),s.dispatchEvent(new Event("close")),C.close()})}return P()}})}).catch(o=>{s.dispatchEvent(new Event("error",{detail:o})),s.dispatchEvent(new Event("close"))}),s}supported(){return this.options.fetch!==null&&this.options.readableStream!==null&&typeof TextDecoder!="undefined"&&typeof AbortController!="undefined"&&typeof EventTarget!="undefined"&&typeof Event!="undefined"&&typeof MessageEvent!="undefined"&&typeof Error!="undefined"}initialize(e,t,n){this._protocol=e,this._abortController=new AbortController;let s,r;e==="json"?(s={Accept:"application/json","Content-Type":"application/json"},r=n):(s={Accept:"application/octet-stream","Content-Type":"application/octet-stream"},r=n);let o={method:"POST",headers:s,body:r,mode:"cors",credentials:"same-origin",signal:this._abortController.signal},a=this._fetchEventTarget(this,this.endpoint,o);a.addEventListener("open",()=>{t.onOpen()}),a.addEventListener("error",c=>{this._abortController.abort(),t.onError(c)}),a.addEventListener("close",()=>{this._abortController.abort(),t.onClose({code:4,reason:"connection closed"})}),a.addEventListener("message",c=>{t.onMessage(c.data)})}close(){this._abortController.abort()}send(e,t,n){let s,r,o={session:t,node:n,data:e};this._protocol==="json"?(s={"Content-Type":"application/json"},r=JSON.stringify(o)):(s={"Content-Type":"application/octet-stream"},r=this.options.encoder.encodeEmulationRequest(o));let a=this.options.fetch,c={method:"POST",headers:s,body:r,mode:"cors",credentials:"same-origin"};a(this.options.emulationEndpoint,c)}},ce=class{constructor(e,t){this.endpoint=e,this.options=t,this._protocol="json",this._transport=null,this._onClose=null}name(){return"sse"}subName(){return"sse"}emulation(){return!0}supported(){return this.options.eventsource!==null&&this.options.fetch!==null}initialize(e,t,n){let s;globalThis&&globalThis.document&&globalThis.document.baseURI?s=new URL(this.endpoint,globalThis.document.baseURI):s=new URL(this.endpoint),s.searchParams.append("cf_connect",n);let r={},o=new this.options.eventsource(s.toString(),r);this._transport=o;let a=this;o.onopen=function(){t.onOpen()},o.onerror=function(c){o.close(),t.onError(c),t.onClose({code:4,reason:"connection closed"})},o.onmessage=function(c){t.onMessage(c.data)},a._onClose=function(){t.onClose({code:4,reason:"connection closed"})}}close(){this._transport.close(),this._onClose!==null&&this._onClose()}send(e,t,n){let s={session:t,node:n,data:e},r={"Content-Type":"application/json"},o=JSON.stringify(s),a=this.options.fetch,c={method:"POST",headers:r,body:o,mode:"cors",credentials:"same-origin"};a(this.options.emulationEndpoint,c)}},ae=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null,this._stream=null,this._writer=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"webtransport"}subName(){return"webtransport"}emulation(){return!1}supported(){return this.options.webtransport!==void 0&&this.options.webtransport!==null}initialize(e,t){return T(this,void 0,void 0,function*(){let n;globalThis&&globalThis.document&&globalThis.document.baseURI?n=new URL(this.endpoint,globalThis.document.baseURI):n=new URL(this.endpoint),e==="protobuf"&&n.searchParams.append("cf_protocol","protobuf"),this._protocol=e;let s=new EventTarget;this._transport=new this.options.webtransport(n.toString()),this._transport.closed.then(()=>{t.onClose({code:4,reason:"connection closed"})}).catch(()=>{t.onClose({code:4,reason:"connection closed"})});try{yield this._transport.ready}catch(o){this.close();return}let r;try{r=yield this._transport.createBidirectionalStream()}catch(o){this.close();return}this._stream=r,this._writer=this._stream.writable.getWriter(),s.addEventListener("close",()=>{t.onClose({code:4,reason:"connection closed"})}),s.addEventListener("message",o=>{t.onMessage(o.data)}),this._startReading(s),t.onOpen()})}_startReading(e){return T(this,void 0,void 0,function*(){let t=this._stream.readable.getReader(),n="",s=0,r=new Uint8Array;try{for(;;){let{done:o,value:a}=yield t.read();if(a.length>0)if(this._protocol==="json")for(n+=this._utf8decoder.decode(a);s<n.length;)if(n[s]===`
`){let c=n.substring(0,s);e.dispatchEvent(new MessageEvent("message",{data:c})),n=n.substring(s+1),s=0}else++s;else{let c=new Uint8Array(r.length+a.length);for(c.set(r),c.set(a,r.length),r=c;;){let u=this.options.decoder.decodeReply(r);if(u.ok){let g=r.slice(0,u.pos);e.dispatchEvent(new MessageEvent("message",{data:g})),r=r.slice(u.pos);continue}break}}if(o)break}}catch(o){e.dispatchEvent(new Event("close"))}})}close(){return T(this,void 0,void 0,function*(){try{this._writer&&(yield this._writer.close()),this._transport.close()}catch(e){}})}send(e){return T(this,void 0,void 0,function*(){let t;this._protocol==="json"?t=new TextEncoder().encode(e+`
`):t=e;try{yield this._writer.write(t)}catch(n){this.close()}})}},it=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,-1,-1,-1,-1,36,-1,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,-1,-1,-1,63,-1],ue=class{constructor(e){this.a=e,this.pos=0}haveBytes(){return this.pos<this.a.length}getByte(){let e=this.a[this.pos];if(this.pos++,this.pos>this.a.length)throw new RangeError("out of bounds");return e}getChar(){return String.fromCharCode(this.getByte())}getInt(){let e=0,t;for(;this.haveBytes()&&(t=it[127&this.getByte()])>=0;)e=(e<<6)+t;return this.pos--,e>>>0}},he=class{constructor(){this.a=[]}toByteArray(e){return Array.isArray(e)?this.a:new Uint8Array(this.a)}putArray(e,t,n){for(let s=t;s<n;s++)this.a.push(e[s])}};function st(i){let e=0,t=0,n=0,s=0,r=0,o=i.length;for(;o>=16;)e=e+i[r+0]|0,t=t+i[r+1]|0,n=n+i[r+2]|0,s=s+i[r+3]|0,e=e+i[r+4]|0,t=t+i[r+5]|0,n=n+i[r+6]|0,s=s+i[r+7]|0,e=e+i[r+8]|0,t=t+i[r+9]|0,n=n+i[r+10]|0,s=s+i[r+11]|0,e=e+i[r+12]|0,t=t+i[r+13]|0,n=n+i[r+14]|0,s=s+i[r+15]|0,r+=16,o-=16;for(;o>=4;)e=e+i[r+0]|0,t=t+i[r+1]|0,n=n+i[r+2]|0,s=s+i[r+3]|0,r+=4,o-=4;switch(s=((s+(n<<8)|0)+(t<<16)|0)+(e<<24)|0,o){case 3:s=s+(i[r+2]<<8)|0;case 2:s=s+(i[r+1]<<16)|0;case 1:s=s+(i[r+0]<<24)|0}return s>>>0}function rt(i,e){let t=0,n=new ue(e),s=i.length,r=e.length,o=n.getInt();if(n.getChar()!==`
`)throw new Error("size integer not terminated by '\\n'");let a=new he;for(;n.haveBytes();){let c=n.getInt(),u;switch(n.getChar()){case"@":if(u=n.getInt(),n.haveBytes()&&n.getChar()!==",")throw new Error("copy command not terminated by ','");if(t+=c,t>o)throw new Error("copy exceeds output file size");if(u+c>s)throw new Error("copy extends past end of input");a.putArray(i,u,u+c);break;case":":if(t+=c,t>o)throw new Error("insert command gives an output larger than predicted");if(c>r)throw new Error("insert count exceeds size of delta");a.putArray(n.a,n.pos,n.pos+c),n.pos+=c;break;case";":{let g=a.toByteArray(i);if(c!==st(g))throw new Error("bad checksum");if(t!==o)throw new Error("generated size does not match predicted size");return g}default:throw new Error("unknown delta operator")}}throw new Error("unterminated delta")}var $=class{name(){return"json"}encodeCommands(e){return e.map(t=>JSON.stringify(t)).join(`
`)}decodeReplies(e){return e.trim().split(`
`).map(t=>JSON.parse(t))}applyDeltaIfNeeded(e,t){let n,s;if(e.delta){let r=rt(t,new TextEncoder().encode(e.data));n=JSON.parse(new TextDecoder().decode(r)),s=r}else n=JSON.parse(e.data),s=new TextEncoder().encode(e.data);return{newData:n,newPrevValue:s}}},ot={headers:{},token:"",getToken:null,data:null,getData:null,debug:!1,name:"js",version:"",fetch:null,readableStream:null,websocket:null,eventsource:null,sockjs:null,sockjsOptions:{},emulationEndpoint:"/emulation",minReconnectDelay:500,maxReconnectDelay:2e4,timeout:5e3,maxServerPingDelay:1e4,networkEventTarget:null},R=class extends Error{constructor(e){super(e),this.name=this.constructor.name}},O=class extends qe{constructor(e,t){super(),this._reconnectTimeout=null,this._refreshTimeout=null,this._serverPingTimeout=null,this.state=p.Disconnected,this._transportIsOpen=!1,this._endpoint=e,this._emulation=!1,this._transports=[],this._currentTransportIndex=0,this._triedAllTransports=!1,this._transportWasOpen=!1,this._transport=null,this._transportId=0,this._deviceWentOffline=!1,this._transportClosed=!0,this._codec=new $,this._reconnecting=!1,this._reconnectTimeout=null,this._reconnectAttempts=0,this._client=null,this._session="",this._node="",this._subs={},this._serverSubs={},this._commandId=0,this._commands=[],this._batching=!1,this._refreshRequired=!1,this._refreshTimeout=null,this._callbacks={},this._token="",this._data=null,this._dispatchPromise=Promise.resolve(),this._serverPing=0,this._serverPingTimeout=null,this._sendPong=!1,this._promises={},this._promiseId=0,this._debugEnabled=!1,this._networkEventsSet=!1,this._config=Object.assign(Object.assign({},ot),t),this._configure(),this._debugEnabled?(this.on("state",n=>{this._debug("client state",n.oldState,"->",n.newState)}),this.on("error",n=>{this._debug("client error",n)})):this.on("error",function(){Function.prototype()})}newSubscription(e,t){if(this.getSubscription(e)!==null)throw new Error("Subscription to the channel "+e+" already exists");let n=new se(this,e,t);return this._subs[e]=n,n}getSubscription(e){return this._getSub(e)}removeSubscription(e){e&&(e.state!==S.Unsubscribed&&e.unsubscribe(),this._removeSubscription(e))}subscriptions(){return this._subs}ready(e){switch(this.state){case p.Disconnected:return Promise.reject({code:d.clientDisconnected,message:"client disconnected"});case p.Connected:return Promise.resolve();default:return new Promise((t,n)=>{let s={resolve:t,reject:n};e&&(s.timeout=setTimeout(()=>{n({code:d.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=s})}}connect(){if(this._isConnected()){this._debug("connect called when already connected");return}if(this._isConnecting()){this._debug("connect called when already connecting");return}this._debug("connect called"),this._reconnectAttempts=0,this._startConnecting()}disconnect(){this._disconnect(M.disconnectCalled,"disconnect called",!1)}setToken(e){this._token=e}setHeaders(e){this._config.headers=e}send(e){return T(this,void 0,void 0,function*(){let t={send:{data:e}};if(yield this._methodCall(),!this._transportSendCommands([t]))throw this._createErrorObject(d.transportWriteError,"transport write error")})}rpc(e,t){return T(this,void 0,void 0,function*(){let n={rpc:{method:e,data:t}};return yield this._methodCall(),{data:(yield this._callPromise(n,r=>r.rpc)).data}})}publish(e,t){return T(this,void 0,void 0,function*(){let n={publish:{channel:e,data:t}};return yield this._methodCall(),yield this._callPromise(n,()=>({})),{}})}history(e,t){return T(this,void 0,void 0,function*(){let n={history:this._getHistoryRequest(e,t)};yield this._methodCall();let s=yield this._callPromise(n,o=>o.history),r=[];if(s.publications)for(let o=0;o<s.publications.length;o++)r.push(this._getPublicationContext(e,s.publications[o]));return{publications:r,epoch:s.epoch||"",offset:s.offset||0}})}presence(e){return T(this,void 0,void 0,function*(){let t={presence:{channel:e}};yield this._methodCall();let s=(yield this._callPromise(t,r=>r.presence)).presence;for(let r in s)if(Object.prototype.hasOwnProperty.call(s,r)){let o=s[r],a=o.conn_info,c=o.chan_info;a&&(o.connInfo=a),c&&(o.chanInfo=c)}return{clients:s}})}presenceStats(e){return T(this,void 0,void 0,function*(){let t={presence_stats:{channel:e}};yield this._methodCall();let n=yield this._callPromise(t,s=>s.presence_stats);return{numUsers:n.num_users,numClients:n.num_clients}})}startBatching(){this._batching=!0}stopBatching(){let e=this;Promise.resolve().then(function(){Promise.resolve().then(function(){e._batching=!1,e._flush()})})}_debug(...e){this._debugEnabled&&et("debug",e)}_codecName(){return this._codec.name()}_formatOverride(){}_configure(){if(!("Promise"in globalThis))throw new Error("Promise polyfill required");if(!this._endpoint)throw new Error("endpoint configuration required");if(this._config.token!==null&&(this._token=this._config.token),this._config.data!==null&&(this._data=this._config.data),this._codec=new $,this._formatOverride(),(this._config.debug===!0||typeof localStorage!="undefined"&&localStorage.getItem("centrifuge.debug"))&&(this._debugEnabled=!0),this._debug("config",this._config),typeof this._endpoint!="string")if(typeof this._endpoint=="object"&&this._endpoint instanceof Array){this._transports=this._endpoint,this._emulation=!0;for(let e in this._transports)if(this._transports.hasOwnProperty(e)){let t=this._transports[e];if(!t.endpoint||!t.transport)throw new Error("malformed transport configuration");let n=t.transport;if(["websocket","http_stream","sse","sockjs","webtransport"].indexOf(n)<0)throw new Error("unsupported transport name: "+n)}}else throw new Error("unsupported url configuration type: only string or array of objects are supported")}_setState(e){if(this.state!==e){this._reconnecting=!1;let t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t}),!0}return!1}_isDisconnected(){return this.state===p.Disconnected}_isConnecting(){return this.state===p.Connecting}_isConnected(){return this.state===p.Connected}_nextCommandId(){return++this._commandId}_setNetworkEvents(){if(this._networkEventsSet)return;let e=null;this._config.networkEventTarget!==null?e=this._config.networkEventTarget:typeof globalThis.addEventListener!="undefined"&&(e=globalThis),e&&(e.addEventListener("offline",()=>{this._debug("offline event triggered"),(this.state===p.Connected||this.state===p.Connecting)&&(this._disconnect(L.transportClosed,"transport closed",!0),this._deviceWentOffline=!0)}),e.addEventListener("online",()=>{this._debug("online event triggered"),this.state===p.Connecting&&(this._deviceWentOffline&&!this._transportClosed&&(this._deviceWentOffline=!1,this._transportClosed=!0),this._clearReconnectTimeout(),this._startReconnecting())}),this._networkEventsSet=!0)}_getReconnectDelay(){let e=V(this._reconnectAttempts,this._config.minReconnectDelay,this._config.maxReconnectDelay);return this._reconnectAttempts+=1,e}_clearOutgoingRequests(){for(let e in this._callbacks)if(this._callbacks.hasOwnProperty(e)){let t=this._callbacks[e];clearTimeout(t.timeout);let n=t.errback;if(!n)continue;n({error:this._createErrorObject(d.connectionClosed,"connection closed")})}this._callbacks={}}_clearConnectedState(){this._client=null,this._clearServerPingTimeout(),this._clearRefreshTimeout();for(let e in this._subs){if(!this._subs.hasOwnProperty(e))continue;let t=this._subs[e];t.state===S.Subscribed&&t._setSubscribing(F.transportClosed,"transport closed")}for(let e in this._serverSubs)this._serverSubs.hasOwnProperty(e)&&this.emit("subscribing",{channel:e})}_handleWriteError(e){for(let t of e){let n=t.id;if(!(n in this._callbacks))continue;let s=this._callbacks[n];clearTimeout(this._callbacks[n].timeout),delete this._callbacks[n];let r=s.errback;r({error:this._createErrorObject(d.transportWriteError,"transport write error")})}}_transportSendCommands(e){if(!e.length)return!0;if(!this._transport)return!1;try{this._transport.send(this._codec.encodeCommands(e),this._session,this._node)}catch(t){return this._debug("error writing commands",t),this._handleWriteError(e),!1}return!0}_initializeTransport(){let e;this._config.websocket!==null?e=this._config.websocket:typeof globalThis.WebSocket!="function"&&typeof globalThis.WebSocket!="object"||(e=globalThis.WebSocket);let t=null;this._config.sockjs!==null?t=this._config.sockjs:typeof globalThis.SockJS!="undefined"&&(t=globalThis.SockJS);let n=null;this._config.eventsource!==null?n=this._config.eventsource:typeof globalThis.EventSource!="undefined"&&(n=globalThis.EventSource);let s=null;this._config.fetch!==null?s=this._config.fetch:typeof globalThis.fetch!="undefined"&&(s=globalThis.fetch);let r=null;if(this._config.readableStream!==null?r=this._config.readableStream:typeof globalThis.ReadableStream!="undefined"&&(r=globalThis.ReadableStream),this._emulation){this._currentTransportIndex>=this._transports.length&&(this._triedAllTransports=!0,this._currentTransportIndex=0);let l=0;for(;;){if(l>=this._transports.length)throw new Error("no supported transport found");let w=this._transports[this._currentTransportIndex],m=w.transport,f=w.endpoint;if(m==="websocket"){if(this._debug("trying websocket transport"),this._transport=new Q(f,{websocket:e}),!this._transport.supported()){this._debug("websocket transport not available"),this._currentTransportIndex++,l++;continue}}else if(m==="webtransport"){if(this._debug("trying webtransport transport"),this._transport=new ae(f,{webtransport:globalThis.WebTransport,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("webtransport transport not available"),this._currentTransportIndex++,l++;continue}}else if(m==="http_stream"){if(this._debug("trying http_stream transport"),this._transport=new oe(f,{fetch:s,readableStream:r,emulationEndpoint:this._config.emulationEndpoint,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("http_stream transport not available"),this._currentTransportIndex++,l++;continue}}else if(m==="sse"){if(this._debug("trying sse transport"),this._transport=new ce(f,{eventsource:n,fetch:s,emulationEndpoint:this._config.emulationEndpoint}),!this._transport.supported()){this._debug("sse transport not available"),this._currentTransportIndex++,l++;continue}}else if(m==="sockjs"){if(this._debug("trying sockjs"),this._transport=new re(f,{sockjs:t,sockjsOptions:this._config.sockjsOptions}),!this._transport.supported()){this._debug("sockjs transport not available"),this._currentTransportIndex++,l++;continue}}else throw new Error("unknown transport "+m);break}}else{if(Ze(this._endpoint,"http"))throw new Error("Provide explicit transport endpoints configuration in case of using HTTP (i.e. using array of TransportEndpoint instead of a single string), or use ws(s):// scheme in an endpoint if you aimed using WebSocket transport");if(this._debug("client will use websocket"),this._transport=new Q(this._endpoint,{websocket:e}),!this._transport.supported())throw new Error("WebSocket constructor not found, make sure it is available globally or passed as a dependency in Centrifuge options")}let o=this,a=this._transport,c=this._nextTransportId();o._debug("id of transport",c);let u=!1,g=[];if(this._transport.emulation()){let l=o._sendConnect(!0);g.push(l)}this._setNetworkEvents();let C=this._codec.encodeCommands(g);this._transportClosed=!1;let P;P=setTimeout(function(){a.close()},this._config.timeout),this._transport.initialize(this._codecName(),{onOpen:function(){if(P&&(clearTimeout(P),P=null),o._transportId!=c){o._debug("open callback from non-actual transport"),a.close();return}u=!0,o._debug(a.subName(),"transport open"),!a.emulation()&&(o._transportIsOpen=!0,o._transportWasOpen=!0,o.startBatching(),o._sendConnect(!1),o._sendSubscribeCommands(),o.stopBatching(),o.emit("__centrifuge_debug:connect_frame_sent",{}))},onError:function(l){if(o._transportId!=c){o._debug("error callback from non-actual transport");return}o._debug("transport level error",l)},onClose:function(l){if(P&&(clearTimeout(P),P=null),o._transportId!=c){o._debug("close callback from non-actual transport");return}o._debug(a.subName(),"transport closed"),o._transportClosed=!0,o._transportIsOpen=!1;let w="connection closed",m=!0,f=0;if(l&&"code"in l&&l.code&&(f=l.code),l&&l.reason)try{let N=JSON.parse(l.reason);w=N.reason,m=N.reconnect}catch(N){w=l.reason,(f>=3500&&f<4e3||f>=4500&&f<5e3)&&(m=!1)}f<3e3?(f===1009?(f=M.messageSizeLimit,w="message size limit exceeded",m=!1):(f=L.transportClosed,w="transport closed"),o._emulation&&!o._transportWasOpen&&(o._currentTransportIndex++,o._currentTransportIndex>=o._transports.length&&(o._triedAllTransports=!0,o._currentTransportIndex=0))):o._transportWasOpen=!0,o._isConnecting()&&!u&&o.emit("error",{type:"transport",error:{code:d.transportClosed,message:"transport closed"},transport:a.name()}),o._reconnecting=!1,o._disconnect(f,w,m)},onMessage:function(l){o._dataReceived(l)}},C),o.emit("__centrifuge_debug:transport_initialized",{})}_sendConnect(e){let t=this._constructConnectCommand(),n=this;return this._call(t,e).then(s=>{let r=s.reply.connect;n._connectResponse(r),s.next&&s.next()},s=>{n._connectError(s.error),s.next&&s.next()}),t}_startReconnecting(){if(this._debug("start reconnecting"),!this._isConnecting()){this._debug("stop reconnecting: client not in connecting state");return}if(this._reconnecting){this._debug("reconnect already in progress, return from reconnect routine");return}if(this._transportClosed===!1){this._debug("waiting for transport close");return}this._reconnecting=!0;let e=this._token==="";if(!(this._refreshRequired||e&&this._config.getToken!==null)){this._config.getData?this._config.getData().then(s=>{this._isConnecting()&&(this._data=s,this._initializeTransport())}).catch(s=>this._handleGetDataError(s)):this._initializeTransport();return}let n=this;this._getToken().then(function(s){if(n._isConnecting()){if(s==null||s==null){n._failUnauthorized();return}n._token=s,n._debug("connection token refreshed"),n._config.getData?n._config.getData().then(function(r){n._isConnecting()&&(n._data=r,n._initializeTransport())}).catch(r=>n._handleGetDataError(r)):n._initializeTransport()}}).catch(function(s){if(!n._isConnecting())return;if(s instanceof R){n._failUnauthorized();return}n.emit("error",{type:"connectToken",error:{code:d.clientConnectToken,message:s!==void 0?s.toString():""}});let r=n._getReconnectDelay();n._debug("error on getting connection token, reconnect after "+r+" milliseconds",s),n._reconnecting=!1,n._reconnectTimeout=setTimeout(()=>{n._startReconnecting()},r)})}_handleGetDataError(e){if(e instanceof R){this._failUnauthorized();return}this.emit("error",{type:"connectData",error:{code:d.badConfiguration,message:(e==null?void 0:e.toString())||""}});let t=this._getReconnectDelay();this._debug("error on getting connect data, reconnect after "+t+" milliseconds",e),this._reconnecting=!1,this._reconnectTimeout=setTimeout(()=>{this._startReconnecting()},t)}_connectError(e){this.state===p.Connecting&&(e.code===109&&(this._refreshRequired=!0),e.code<100||e.temporary===!0||e.code===109?(this.emit("error",{type:"connect",error:e}),this._debug("closing transport due to connect error"),this._disconnect(e.code,e.message,!0)):this._disconnect(e.code,e.message,!1))}_scheduleReconnect(){if(!this._isConnecting())return;let e=!1;this._emulation&&!this._transportWasOpen&&!this._triedAllTransports&&(e=!0);let t=this._getReconnectDelay();e&&(t=0),this._debug("reconnect after "+t+" milliseconds"),this._clearReconnectTimeout(),this._reconnectTimeout=setTimeout(()=>{this._startReconnecting()},t)}_constructConnectCommand(){let e={};this._token&&(e.token=this._token),this._data&&(e.data=this._data),this._config.name&&(e.name=this._config.name),this._config.version&&(e.version=this._config.version),Object.keys(this._config.headers).length>0&&(e.headers=this._config.headers);let t={},n=!1;for(let s in this._serverSubs)if(this._serverSubs.hasOwnProperty(s)&&this._serverSubs[s].recoverable){n=!0;let r={recover:!0};this._serverSubs[s].offset&&(r.offset=this._serverSubs[s].offset),this._serverSubs[s].epoch&&(r.epoch=this._serverSubs[s].epoch),t[s]=r}return n&&(e.subs=t),{connect:e}}_getHistoryRequest(e,t){let n={channel:e};return t!==void 0&&(t.since&&(n.since={offset:t.since.offset},t.since.epoch&&(n.since.epoch=t.since.epoch)),t.limit!==void 0&&(n.limit=t.limit),t.reverse===!0&&(n.reverse=!0)),n}_methodCall(){return this._isConnected()?Promise.resolve():new Promise((e,t)=>{let n=setTimeout(function(){t({code:d.timeout,message:"timeout"})},this._config.timeout);this._promises[this._nextPromiseId()]={timeout:n,resolve:e,reject:t}})}_callPromise(e,t){return new Promise((n,s)=>{this._call(e,!1).then(r=>{var o;let a=t(r.reply);n(a),(o=r.next)===null||o===void 0||o.call(r)},r=>{var o;s(r.error),(o=r.next)===null||o===void 0||o.call(r)})})}_dataReceived(e){this._serverPing>0&&this._waitServerPing();let t=this._codec.decodeReplies(e);this._dispatchPromise=this._dispatchPromise.then(()=>{let n;this._dispatchPromise=new Promise(s=>{n=s}),this._dispatchSynchronized(t,n)})}_dispatchSynchronized(e,t){let n=Promise.resolve();for(let s in e)e.hasOwnProperty(s)&&(n=n.then(()=>this._dispatchReply(e[s])));n=n.then(()=>{t()})}_dispatchReply(e){let t,n=new Promise(r=>{t=r});if(e==null)return this._debug("dispatch: got undefined or null reply"),t(),n;let s=e.id;return s&&s>0?this._handleReply(e,t):e.push?this._handlePush(e.push,t):this._handleServerPing(t),n}_call(e,t){return new Promise((n,s)=>{e.id=this._nextCommandId(),this._registerCall(e.id,n,s),t||this._addCommand(e)})}_startConnecting(){this._debug("start connecting"),this._setState(p.Connecting)&&this.emit("connecting",{code:L.connectCalled,reason:"connect called"}),this._client=null,this._startReconnecting()}_disconnect(e,t,n){if(this._isDisconnected())return;this._transportIsOpen=!1;let s=this.state;this._reconnecting=!1;let r={code:e,reason:t},o=!1;if(n?o=this._setState(p.Connecting):(o=this._setState(p.Disconnected),this._rejectPromises({code:d.clientDisconnected,message:"disconnected"})),this._clearOutgoingRequests(),s===p.Connecting&&this._clearReconnectTimeout(),s===p.Connected&&this._clearConnectedState(),o&&(this._isConnecting()?this.emit("connecting",r):this.emit("disconnected",r)),this._transport){this._debug("closing existing transport");let a=this._transport;this._transport=null,a.close(),this._transportClosed=!0,this._nextTransportId()}else this._debug("no transport to close");this._scheduleReconnect()}_failUnauthorized(){this._disconnect(M.unauthorized,"unauthorized",!1)}_getToken(){return this._debug("get connection token"),this._config.getToken?this._config.getToken({}):(this.emit("error",{type:"configuration",error:{code:d.badConfiguration,message:"token expired but no getToken function set in the configuration"}}),Promise.reject(new R("")))}_refresh(){let e=this._client,t=this;this._getToken().then(function(n){if(e!==t._client)return;if(!n){t._failUnauthorized();return}if(t._token=n,t._debug("connection token refreshed"),!t._isConnected())return;let s={refresh:{token:t._token}};t._call(s,!1).then(r=>{let o=r.reply.refresh;t._refreshResponse(o),r.next&&r.next()},r=>{t._refreshError(r.error),r.next&&r.next()})}).catch(function(n){if(t._isConnected()){if(n instanceof R){t._failUnauthorized();return}t.emit("error",{type:"refreshToken",error:{code:d.clientRefreshToken,message:n!==void 0?n.toString():""}}),t._refreshTimeout=setTimeout(()=>t._refresh(),t._getRefreshRetryDelay())}})}_refreshError(e){e.code<100||e.temporary===!0?(this.emit("error",{type:"refresh",error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._disconnect(e.code,e.message,!1)}_getRefreshRetryDelay(){return V(0,5e3,1e4)}_refreshResponse(e){this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null),e.expires&&(this._client=e.client,this._refreshTimeout=setTimeout(()=>this._refresh(),H(e.ttl)))}_removeSubscription(e){e!==null&&delete this._subs[e.channel]}_unsubscribe(e){if(!this._transportIsOpen)return Promise.resolve();let n={unsubscribe:{channel:e.channel}},s=this;return new Promise((o,a)=>{this._call(n,!1).then(c=>{o(),c.next&&c.next()},c=>{o(),c.next&&c.next(),s._disconnect(L.unsubscribeError,"unsubscribe error",!0)})})}_getSub(e){let t=this._subs[e];return t||null}_isServerSub(e){return this._serverSubs[e]!==void 0}_sendSubscribeCommands(){let e=[];for(let t in this._subs){if(!this._subs.hasOwnProperty(t))continue;let n=this._subs[t];if(n._inflight!==!0&&n.state===S.Subscribing){let s=n._subscribe();s&&e.push(s)}}return e}_connectResponse(e){if(this._transportIsOpen=!0,this._transportWasOpen=!0,this._reconnectAttempts=0,this._refreshRequired=!1,this._isConnected())return;this._client=e.client,this._setState(p.Connected),this._refreshTimeout&&clearTimeout(this._refreshTimeout),e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),H(e.ttl))),this._session=e.session,this._node=e.node,this.startBatching(),this._sendSubscribeCommands(),this.stopBatching();let t={client:e.client,transport:this._transport.subName()};e.data&&(t.data=e.data),this.emit("connected",t),this._resolvePromises(),this._processServerSubs(e.subs||{}),e.ping&&e.ping>0?(this._serverPing=e.ping*1e3,this._sendPong=e.pong===!0,this._waitServerPing()):this._serverPing=0}_processServerSubs(e){for(let t in e){if(!e.hasOwnProperty(t))continue;let n=e[t];this._serverSubs[t]={offset:n.offset,epoch:n.epoch,recoverable:n.recoverable||!1};let s=this._getSubscribeContext(t,n);this.emit("subscribed",s)}for(let t in e){if(!e.hasOwnProperty(t))continue;let n=e[t];if(n.recovered){let s=n.publications;if(s&&s.length>0)for(let r in s)s.hasOwnProperty(r)&&this._handlePublication(t,s[r])}}for(let t in this._serverSubs)this._serverSubs.hasOwnProperty(t)&&(e[t]||(this.emit("unsubscribed",{channel:t}),delete this._serverSubs[t]))}_clearRefreshTimeout(){this._refreshTimeout!==null&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearReconnectTimeout(){this._reconnectTimeout!==null&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null)}_clearServerPingTimeout(){this._serverPingTimeout!==null&&(clearTimeout(this._serverPingTimeout),this._serverPingTimeout=null)}_waitServerPing(){this._config.maxServerPingDelay!==0&&this._isConnected()&&(this._clearServerPingTimeout(),this._serverPingTimeout=setTimeout(()=>{this._isConnected()&&this._disconnect(L.noPing,"no ping",!0)},this._serverPing+this._config.maxServerPingDelay))}_getSubscribeContext(e,t){let n={channel:e,positioned:!1,recoverable:!1,wasRecovering:!1,recovered:!1,hasRecoveredPublications:!1};t.recovered&&(n.recovered=!0),t.positioned&&(n.positioned=!0),t.recoverable&&(n.recoverable=!0),t.was_recovering&&(n.wasRecovering=!0);let s="";"epoch"in t&&(s=t.epoch);let r=0;return"offset"in t&&(r=t.offset),(n.positioned||n.recoverable)&&(n.streamPosition={offset:r,epoch:s}),Array.isArray(t.publications)&&t.publications.length>0&&(n.hasRecoveredPublications=!0),t.data&&(n.data=t.data),n}_handleReply(e,t){let n=e.id;if(!(n in this._callbacks)){t();return}let s=this._callbacks[n];if(clearTimeout(this._callbacks[n].timeout),delete this._callbacks[n],nt(e)){let r=s.errback;if(!r){t();return}let o={code:e.error.code,message:e.error.message||"",temporary:e.error.temporary||!1};r({error:o,next:t})}else{let r=s.callback;if(!r)return;r({reply:e,next:t})}}_handleJoin(e,t){let n=this._getSub(e);if(!n){if(this._isServerSub(e)){let s={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("join",s)}return}n._handleJoin(t)}_handleLeave(e,t){let n=this._getSub(e);if(!n){if(this._isServerSub(e)){let s={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("leave",s)}return}n._handleLeave(t)}_handleUnsubscribe(e,t){let n=this._getSub(e);if(!n){this._isServerSub(e)&&(delete this._serverSubs[e],this.emit("unsubscribed",{channel:e}));return}t.code<2500?n._setUnsubscribed(t.code,t.reason,!1):n._setSubscribing(t.code,t.reason)}_handleSubscribe(e,t){this._serverSubs[e]={offset:t.offset,epoch:t.epoch,recoverable:t.recoverable||!1},this.emit("subscribed",this._getSubscribeContext(e,t))}_handleDisconnect(e){let t=e.code,n=!0;(t>=3500&&t<4e3||t>=4500&&t<5e3)&&(n=!1),this._disconnect(t,e.reason,n)}_getPublicationContext(e,t){let n={channel:e,data:t.data};return t.offset&&(n.offset=t.offset),t.info&&(n.info=this._getJoinLeaveContext(t.info)),t.tags&&(n.tags=t.tags),n}_getJoinLeaveContext(e){let t={client:e.client,user:e.user},n=e.conn_info;n&&(t.connInfo=n);let s=e.chan_info;return s&&(t.chanInfo=s),t}_handlePublication(e,t){let n=this._getSub(e);if(!n){if(this._isServerSub(e)){let s=this._getPublicationContext(e,t);this.emit("publication",s),t.offset!==void 0&&(this._serverSubs[e].offset=t.offset)}return}n._handlePublication(t)}_handleMessage(e){this.emit("message",{data:e.data})}_handleServerPing(e){if(this._sendPong){let t={};this._transportSendCommands([t])}e()}_handlePush(e,t){let n=e.channel;e.pub?this._handlePublication(n,e.pub):e.message?this._handleMessage(e.message):e.join?this._handleJoin(n,e.join):e.leave?this._handleLeave(n,e.leave):e.unsubscribe?this._handleUnsubscribe(n,e.unsubscribe):e.subscribe?this._handleSubscribe(n,e.subscribe):e.disconnect&&this._handleDisconnect(e.disconnect),t()}_flush(){let e=this._commands.slice(0);this._commands=[],this._transportSendCommands(e)}_createErrorObject(e,t,n){let s={code:e,message:t};return n&&(s.temporary=!0),s}_registerCall(e,t,n){this._callbacks[e]={callback:t,errback:n,timeout:null},this._callbacks[e].timeout=setTimeout(()=>{delete this._callbacks[e],We(n)&&n({error:this._createErrorObject(d.timeout,"timeout")})},this._config.timeout)}_addCommand(e){this._batching?this._commands.push(e):this._transportSendCommands([e])}_nextPromiseId(){return++this._promiseId}_nextTransportId(){return++this._transportId}_resolvePromises(){for(let e in this._promises)this._promises.hasOwnProperty(e)&&(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(let t in this._promises)this._promises.hasOwnProperty(t)&&(this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t])}};O.SubscriptionState=S;O.State=p;O.UnauthorizedError=R;var K=class{constructor(e){this.pollingId=null;this.qrContainer=null;this.location=null;this.apiKey="";this.centrifuge=null;this.currentSubscription=null;this.sessionId="";this.expirationTimerRef=null;this.apiKey=e}configure(e){this.options=e}clearPolling(){this.pollingId!==null&&(clearInterval(this.pollingId),this.pollingId=null)}displayQRCode(e,t){var n;if(this.qrContainer=E(this.options.qrContainerSelector),!this.qrContainer){y("QR Container not found"),this.clearPolling();return}this.qrContainer.innerHTML=Re(e),(n=document.getElementById("qr-code"))==null||n.addEventListener("click",()=>window.open(t,"_blank"))}startPolling(e){if(this.clearPolling(),!e)throw new Error("Session ID not found");this.pollingId=window.setInterval(()=>b(this,null,function*(){try{let t=`${I}${pe}/${e}`,n=yield te(t,{[Y]:this.apiKey});x(E(this.options.logContainerSelector||""),n.scanningState),n!=null&&n.scanningState&&(yield this.handleState(n.scanningState))}catch(t){this.qrContainer&&(this.qrContainer.innerHTML=ee()),y("Polling error",t),yield this.handleState(_.Timeout),this.clearPolling()}}),Te)}handleState(e){return b(this,null,function*(){let t=this.options;if(!t.qrContainerSelector){y("QR Container selector not provided"),this.clearPolling();return}switch(e){case _.WaitingForScan:return;case _.Scanned:return t.onVerificationScanning();case _.Approved:return this.clearPolling(),this.currentSubscription&&(yield this.unsubscribeFromChannel(this.currentSubscription)),t.onVerificationSuccess();case _.RejectedByUser:return this.clearPolling(),this.currentSubscription&&(yield this.unsubscribeFromChannel(this.currentSubscription)),t.onVerificationRejectedByUser();case _.RejectedByRequirement:return this.clearPolling(),this.currentSubscription&&(yield this.unsubscribeFromChannel(this.currentSubscription)),t.onVerificationRejectedByRequirements();case _.Timeout:return this.clearPolling(),this.currentSubscription&&(yield this.unsubscribeFromChannel(this.currentSubscription)),t.onVerificationTimeout();case _.SomethingWentWrong:return this.clearPolling(),this.currentSubscription&&(yield this.unsubscribeFromChannel(this.currentSubscription)),t.onVerificationFailure()}})}validateIdentityAndGenerateQRCode(){return b(this,null,function*(){try{this.qrContainer=E(this.options.qrContainerSelector),this.location=yield Ce();let e=`${I}${me}`,t=yield ne(e,{token:this.apiKey,successNavigateUrl:this.options.successRedirectURL,failureNavigateUrl:this.options.failRedirectURL,notificationUrl:this.options.notificationURL});if(!t.status||!t.data)throw new Error("Invalid identity");let{contextType:n,entityId:s,orgId:r}=t.data;switch(n){case Se.AGE_APP:yield this.generateAgeAppQRCode(s,r);break;default:y("Unknown context type");break}return}catch(e){y("Failed to generate QR code:",e)}})}generateAgeAppQRCode(e,t){return b(this,null,function*(){var n,s;try{this.sessionId&&this.currentSubscription&&(yield this.unsubscribeFromChannel(this.currentSubscription));let r=`${I}${_e}/${e}?notificationURL=${this.options.notificationURL}&latitude=${(n=this.location)==null?void 0:n.latitude}&longitude=${(s=this.location)==null?void 0:s.longitude}`,o=yield te(r,{[Y]:this.apiKey,[ye]:t});this.displayQRCode(o.qrCodeUrl,o.deepLink);let a=E(this.options.logContainerSelector||"");a&&(a.innerHTML="",x(a,_.WaitingForScan));let c=this.subscribeToChannel(o.sessionId),u=this.qrSessionTimeout(o.expiresAt);yield Promise.all([c,u]),this.sessionId=o.sessionId,k("QR code generated successfully")}catch(r){this.qrContainer&&(this.qrContainer.innerHTML=ee()),y("Failed to generate Age App QR code:",r)}})}qrSessionTimeout(e){return b(this,null,function*(){try{if(this.expirationTimerRef&&(clearTimeout(this.expirationTimerRef),this.expirationTimerRef=null),e){let t=new Date(e).getTime(),n=Date.now(),s=t-n;s>0&&(this.expirationTimerRef=setTimeout(()=>b(this,null,function*(){x(E(this.options.logContainerSelector||""),_.Timeout,"QR Code session expired."),this.pollingId&&this.clearPolling(),yield this.handleState(_.Timeout),k("QR code session expired")}),s))}}catch(t){y("Session deletion error:",t)}})}unsubscribeFromChannel(e){return b(this,null,function*(){try{e&&(e.unsubscribe(),k("Unsubscribed from channel successfully")),this.centrifuge&&(this.centrifuge.disconnect(),k("Centrifuge disconnected successfully")),yield xe(`${I}${ge}/${this.sessionId}`,{token:this.apiKey}),this.sessionId="",k("Session destroyed successfully")}catch(t){y("Centrifuge unsubscription/disconnection error:",t)}})}subscribeToChannel(e){return b(this,null,function*(){try{let t=yield ne(`${I}${be}`,{});this.centrifuge=new O(ve,{token:t.token}),this.centrifuge.connect();let n=this.centrifuge.newSubscription(e);this.currentSubscription=n,n.on("publication",s=>b(this,null,function*(){let{data:r}=s.data;r!=null&&r.scanningState&&(x(E(this.options.logContainerSelector||""),r.scanningState),yield this.handleState(r.scanningState))})),n.subscribe()}catch(t){y("Centrifuge subscription error, falling back to polling:",t),this.startPolling(e)}})}};var v=(()=>{let i=null,e,t="",n="";function s(o){if(i=document.querySelector(o.qrCodeSelector),!i){k("QR Container not found",i);return}e=o.generateQRCodeFunction,t=o.successRedirectURL||"",n=o.failRedirectURL||""}function r(o){var c;if(!i){k("QR Container not found",i);return}let a=we(o);i.innerHTML=`<div style="
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        flex-direction: column;
        ">${a}</div>`,(o===_.Timeout||o===_.Scanned)&&e&&((c=document.getElementById("new-qr-button"))==null||c.addEventListener("click",e)),o===_.Approved&&t&&W(t,q),(o===_.RejectedByUser||o===_.RejectedByRequirement)&&n&&W(n,q),o===_.SomethingWentWrong&&n&&W(n,q)}return{setOptions:s,handleState:r,STATES:_}})();(()=>{let{apiKey:i,successRedirectURL:e,failRedirectURL:t,notificationURL:n}=Pe();if(!i)return y("Missing 'apiKey' in script tag. Example usage: <script src='...main.js data-api-key=your-api-key'>");let s=new K(i);s.configure({qrContainerSelector:Z,logContainerSelector:A,successRedirectURL:e,failRedirectURL:t,notificationURL:n,onVerificationWaitingForScan:()=>v.handleState(v.STATES.WaitingForScan),onVerificationSuccess:()=>v.handleState(v.STATES.Approved),onVerificationFailure:()=>v.handleState(v.STATES.SomethingWentWrong),onVerificationScanning:()=>v.handleState(v.STATES.Scanned),onVerificationRejectedByUser:()=>v.handleState(v.STATES.RejectedByUser),onVerificationRejectedByRequirements:()=>v.handleState(v.STATES.RejectedByRequirement),onVerificationTimeout:()=>v.handleState(v.STATES.Timeout)}),v.setOptions({qrCodeSelector:Z,generateQRCodeFunction:()=>s.validateIdentityAndGenerateQRCode(),successRedirectURL:e,failRedirectURL:t}),console.log("Bit Identity Verification initialized."),window.bitIdentityVerification=s,s.validateIdentityAndGenerateQRCode()})();})();
