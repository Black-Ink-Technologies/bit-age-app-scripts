"use strict";var IdentityVerificationCDN=(()=>{var B=Object.defineProperty;var b=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var _=(e,n,t)=>n in e?B(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,A=(e,n)=>{for(var t in n||(n={}))$.call(n,t)&&_(e,t,n[t]);if(b)for(var t of b(n))F.call(n,t)&&_(e,t,n[t]);return e};var d=(e,n,t)=>new Promise((o,r)=>{var a=l=>{try{p(t.next(l))}catch(L){r(L)}},i=l=>{try{p(t.throw(l))}catch(L){r(L)}},p=l=>l.done?o(l.value):Promise.resolve(l.value).then(a,i);p((t=t.apply(e,n)).next())});var h="https://develop-api.chainit.online",C="/rule-engine/v1/age-app-embed/generate-qr",N="/rule-engine/v1/age-app-embed/get-qr",O="/public-api/v1/embed/validate",I="x-sign-key",M="x-organization-id",U={"Content-Type":"application/json"},q={AGE_APP:"age_app",CHECK_IN:"check_in"},v="#embed-qr-code",f="#embed-qr-code-logs",G=1500,E=1e4,s={WaitingForScan:"WaitingForScan",Timeout:"Timeout",Scanned:"Scanned",Approved:"Approved",RejectedByUser:"RejectedByUser",RejectedByRequirement:"RejectedByRequirement",SomethingWentWrong:"SomethingWentWrong"};var D=e=>({Timeout:`
    <div style="margin-bottom: 10px; color: #fff;">QR Expired.</div>
    <a id='new-qr-button' style="
      margin-top: 10px;
      display: inline-block;
      padding: 10px 20px;
      background-color: #000;
      border: 1px solid #fff;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      cursor:pointer;
    ">New QR</a>
  `,Scanned:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u23F3</div>
    <div style="color: #fff;">Scanning In Progress...</div>
  `,Approved:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u2705</div>
    <div style="color: #00ff99;">Access Granted</div>
  `,RejectedByUser:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Access Denied</div>
  `,RejectedByRequirement:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u274C</div>
    <div style="color: #ff4444;">Access Denied</div>
  `,WaitingForScan:"",SomethingWentWrong:`
    <div style="font-size: 30px; margin-bottom: 10px;">\u26A0\uFE0F</div>
    <div style="color: #ff4444;">Something Went Wrong</div>
  `})[e],V=e=>({Timeout:"QR Expired",Scanned:"Scanning in progress",Approved:"Access Granted",RejectedByUser:"Access Denied",RejectedByRequirement:"Access Denied",WaitingForScan:"Waiting for scan",SomethingWentWrong:"Something went wrong"})[e],w=(e="Something went wrong")=>`<div style="background:#111;color:#fff;padding:10px 14px;border-radius:6px;font-size:14px;">${e}</div>`;function k(e){return`
    <div id="qr-code" class="w-100 h-100" style="cursor:pointer;text-align:center;">
      <img src="${e}" alt="QR Code" style="width:100%;height:100%;" />
    </div>
    `}var u=e=>document.querySelector(e);function R(e,n,t){if(!e)return;let o=document.createElement("p");o.innerHTML=t||V(n),o.style.cssText="margin-bottom:10px;padding:8px;",e.prepend(o)}var y=(e,n)=>setTimeout(()=>window.location.href=e,n);var S=(...e)=>console.log("[cdn-embed]",...e),g=(...e)=>console.error("[cdn-embed]",...e),m=(...e)=>console.warn("[cdn-embed]",...e);var W=()=>{let e=document.currentScript;return{apiKey:(e==null?void 0:e.dataset.apiKey)||"",successRedirectURL:(e==null?void 0:e.dataset.successUrl)||"",failRedirectURL:(e==null?void 0:e.dataset.failureUrl)||"",notificationURL:(e==null?void 0:e.dataset.notificationUrl)||""}},H=()=>d(null,null,function*(){try{return(yield K())==="denied"?(m("Geolocation permission denied by user."),yield T()):"geolocation"in navigator?yield new Promise(n=>{navigator.geolocation.getCurrentPosition(t=>{var a,i,p,l;let o=(i=(a=t==null?void 0:t.coords)==null?void 0:a.latitude)!=null?i:0,r=(l=(p=t==null?void 0:t.coords)==null?void 0:p.longitude)!=null?l:0;n({latitude:o,longitude:r})},t=>d(null,null,function*(){let o="";switch(t.code){case t.PERMISSION_DENIED:o="User denied location access.";break;case t.POSITION_UNAVAILABLE:o="Location position unavailable.";break;case t.TIMEOUT:o="Location request timed out.";break;default:o="Unknown geolocation error."}g(`ERR_LOC: ${o}`,t);let r=yield T();n(r)}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}):(m("Geolocation API not supported by this browser."),yield T())}catch(e){return g("Unexpected geolocation error:",e),yield T()}}),T=()=>d(null,null,function*(){try{let n=yield(yield fetch("https://ipapi.co/json/")).json();if(n&&n.latitude&&n.longitude)return m("Fallback via IP-based location:",n.latitude,n.longitude),{latitude:n.latitude,longitude:n.longitude}}catch(e){m("IP-based geolocation failed:",e)}return m("Returning final fallback location (0,0)."),{latitude:0,longitude:0}}),K=()=>d(null,null,function*(){if(!("permissions"in navigator))return"prompt";try{return(yield navigator.permissions.query({name:"geolocation"})).state}catch(e){return"prompt"}});function P(t){return d(this,arguments,function*(e,n={}){let o=yield fetch(e,{method:"GET",headers:n});if(!o.ok){let r=yield o.json(),a=j(r);throw R(u(f||""),"SomethingWentWrong"),new Error(`${o.status} : ${a}`)}return o.json()})}function Q(o,r){return d(this,arguments,function*(e,n,t={}){let a=yield fetch(e,{method:"POST",headers:A(A({},U),t),body:JSON.stringify(n)});if(!a.ok){let i=yield a.json(),p=j(i);throw R(u(f||""),"SomethingWentWrong"),new Error(`${a.status} : ${p}`)}return a.json()})}function j(e){var t;let n="Something Went Wrong";return e!=null&&e.errors&&((t=e==null?void 0:e.errors)!=null&&t.length)?n=e.errors[0].message:e.message&&(n=e.message),n}var x=class{constructor(n){this.pollingId=null;this.qrContainer=null;this.location=null;this.apiKey="";this.apiKey=n}configure(n){this.options=n}clearPolling(){this.pollingId!==null&&(clearInterval(this.pollingId),this.pollingId=null)}displayQRCode(n,t){var o;if(this.qrContainer=u(this.options.qrContainerSelector),!this.qrContainer){g("QR Container not found"),this.clearPolling();return}this.qrContainer.innerHTML=k(n),(o=document.getElementById("qr-code"))==null||o.addEventListener("click",()=>window.open(t,"_blank"))}startPolling(n){if(this.clearPolling(),!n)throw new Error("Session ID not found");this.pollingId=window.setInterval(()=>d(this,null,function*(){try{let t=`${h}${N}/${n}`,o=yield P(t,{[I]:this.apiKey});R(u(this.options.logContainerSelector||""),o.scanningState),o!=null&&o.scanningState&&(yield this.handleState(o.scanningState))}catch(t){this.qrContainer&&(this.qrContainer.innerHTML=w()),g("Polling error",t),yield this.handleState(s.Timeout),this.clearPolling()}}),G)}handleState(n){return d(this,null,function*(){let t=this.options;if(!t.qrContainerSelector){g("QR Container selector not provided"),this.clearPolling();return}switch(n){case s.WaitingForScan:return;case s.Scanned:return t.onVerificationScanning();case s.Approved:return this.clearPolling(),t.onVerificationSuccess();case s.RejectedByUser:return this.clearPolling(),t.onVerificationRejectedByUser();case s.RejectedByRequirement:return this.clearPolling(),t.onVerificationRejectedByRequirements();case s.Timeout:return this.clearPolling(),t.onVerificationTimeout();case s.SomethingWentWrong:return this.clearPolling(),t.onVerificationFailure()}})}validateIdentityAndGenerateQRCode(){return d(this,null,function*(){try{this.qrContainer=u(this.options.qrContainerSelector),this.location=yield H();let n=`${h}${O}`,t=yield Q(n,{token:this.apiKey,successNavigateUrl:this.options.successRedirectURL,failureNavigateUrl:this.options.failRedirectURL,notificationUrl:this.options.notificationURL});if(!t.status||!t.data)throw new Error("Invalid identity");let{contextType:o,entityId:r,orgId:a}=t.data;switch(o){case q.AGE_APP:yield this.generateAgeAppQRCode(r,a);break;default:g("Unknown context type");break}return}catch(n){g("Failed to generate QR code:",n)}})}generateAgeAppQRCode(n,t){return d(this,null,function*(){var o,r;try{let a=`${h}${C}/${n}?notificationURL=${this.options.notificationURL}&latitude=${(o=this.location)==null?void 0:o.latitude}&longitude=${(r=this.location)==null?void 0:r.longitude}`,i=yield P(a,{[I]:this.apiKey,[M]:t});this.displayQRCode(i.qrCodeUrl,i.deepLink),this.startPolling(i.sessionId),S("QR code generated successfully")}catch(a){this.qrContainer&&(this.qrContainer.innerHTML=w()),g("Failed to generate Age App QR code:",a)}})}};var c=(()=>{let e=null,n,t="",o="";function r(i){if(e=document.querySelector(i.qrCodeSelector),!e){S("QR Container not found",e);return}n=i.generateQRCodeFunction,t=i.successRedirectURL||"",o=i.failRedirectURL||""}function a(i){var l;if(!e){S("QR Container not found",e);return}let p=D(i);e.innerHTML=`<div style="
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        flex-direction: column;
        ">${p}</div>`,i===s.Timeout&&n&&((l=document.getElementById("new-qr-button"))==null||l.addEventListener("click",n)),i===s.Approved&&t&&y(t,E),(i===s.RejectedByUser||i===s.RejectedByRequirement)&&o&&y(o,E),i===s.SomethingWentWrong&&o&&y(o,E)}return{setOptions:r,handleState:a,STATES:s}})();(()=>{let{apiKey:e,successRedirectURL:n,failRedirectURL:t,notificationURL:o}=W();if(!e)return g("Missing 'apiKey' in script tag. Example usage: <script src='...main.js data-api-key=your-api-key'>");let r=new x(e);r.configure({qrContainerSelector:v,logContainerSelector:f,successRedirectURL:n,failRedirectURL:t,notificationURL:o,onVerificationWaitingForScan:()=>c.handleState(c.STATES.WaitingForScan),onVerificationSuccess:()=>c.handleState(c.STATES.Approved),onVerificationFailure:()=>c.handleState(c.STATES.SomethingWentWrong),onVerificationScanning:()=>c.handleState(c.STATES.Scanned),onVerificationRejectedByUser:()=>c.handleState(c.STATES.RejectedByUser),onVerificationRejectedByRequirements:()=>c.handleState(c.STATES.RejectedByRequirement),onVerificationTimeout:()=>c.handleState(c.STATES.Timeout)}),c.setOptions({qrCodeSelector:v,generateQRCodeFunction:()=>r.validateIdentityAndGenerateQRCode(),successRedirectURL:n,failRedirectURL:t}),window.bitIdentityVerification=r,r.validateIdentityAndGenerateQRCode()})();})();
